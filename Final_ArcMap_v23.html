<!DOCTYPE html>
<html>
  <head>
    <title>Shared-Use Mobility in Los Angeles</title>
    <link rel="icon" href="http://sandbox.idre.ucla.edu/up206b/groups/excela/wp-content/uploads/2014/05/Favicon16px.png" type="image/x-icon" />

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <!-- jQuery Library -->
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    
    <!-- jQueryUI -->
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />

    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    
    <!-- bootstrap -->
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="dist/bootstrap.css">
    <link rel="stylesheet" href="dist/toggle-switch.css">
  
    <!-- Excela style sheet -->
    <link rel="stylesheet" type="text/css" href="CSS\ExcelaStyle_v5.css">

    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places,geometry"></script>

    <!-- Google Fusion Tables -->
    <link href="/apis/fusiontables/docs/samples/style/default.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>

    <!-- ArcMap -->
    <script type="text/javascript" src="http://sandbox.idre.ucla.edu/up206b/scripts/arcgislink.js"></script>

    <!-- high charts -->
    <script src="http://code.highcharts.com/highcharts.js"></script>

    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>
<!--     <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'> -->

<!-- Javascript -->
<script type="text/javascript">

google.load('visualization', '1');

//global variables
var map;
var la = new google.maps.LatLng(34.027624, -118.406525);

// declare namespace
var excela={};

var polygons=[];

var busstop = [];
var busstop2 = [];
var busstoplite=[];
var cityCircle; 
var bounds;
var distancemeterslimit=800;
var centermarker;

var lastClickedRoute;

var vehperhh;

var bikenetwork = new google.maps.BicyclingLayer();

var railnetwork = new google.maps.FusionTablesLayer({
  query: {
    from: '1CmjLkBR9c8uhdoDLREinBD3qTEOfpIqJGGCVK5y_'
  },
  styles: [{
    markerOptions: {
      iconName: "measle_white"
    },
    polylineOptions: {
    strokeColor: "#66CD00",
    strokeWeight: "5",
    }
  }]
});

//var metrorail ={};
//metrorail.fusionTableID = '1CmjLkBR9c8uhdoDLREinBD3qTEOfpIqJGGCVK5y_';
//metrorail.fusionTableRows;

var fusionZipcarLayer;
var zipcar = {};
zipcar.fusionTableID = '1eMspT0xMpbCIWcN9DTSY6fCGZvVtCXqdWiDB62dI';
zipcar.fusionTableRows;

zipcar.initialize = function() {

  zipcar.initializeFusionTableData(function() {
    zipcar.infoWindow = new google.maps.InfoWindow({ pixelOffset: new google.maps.Size(0,-25)});
    zipcar.initializeAllMarkers(zipcar.fusionTableRows, map);
    zipcar.updateMarkers();
  });

}

zipcar.initializeFusionTableData = function(callback) {

  var query = "SELECT * FROM " + zipcar.fusionTableID;
  query = encodeURIComponent(query);
  var gvizQuery = new google.visualization.Query(
      'http://www.google.com/fusiontables/gvizdata?tq=' + query);
  gvizQuery.send(function(response) {
    var rows = [];
    var numRows = response.getDataTable().getNumberOfRows();
    var dataTable = response.getDataTable()
    // For each row in the table, create a marker
    for (var i = 0; i < numRows; i++) {
      var row = {};
      row['Lat'] = dataTable.getValue(i, 7);
      row['Long'] = dataTable.getValue(i, 8);
      row['Name'] = dataTable.getValue(i, 1);
      row['Address'] = dataTable.getValue(i, 2);
      row['City'] = dataTable.getValue(i, 3);
      row['State'] = dataTable.getValue(i, 4);
      row['Zip'] = dataTable.getValue(i, 5);
      row['NumVeh'] = dataTable.getValue(i, 6);


      rows.push(row);
      // rows.push(dataTable.getRowProperties(i).toString());
    }

    zipcar.fusionTableRows = rows;
    callback();
  });
  
}

zipcar.initializeAllMarkers = function(arrayOfZipcarRows, aMap) {
  zipcar.markers = [];

  arrayOfZipcarRows.forEach(function(row) {
    var lat = row['Lat'];
    var lng = row['Long'];
    var name = row['Name'];
    var address = row['Address'];
    var numveh = row['NumVeh'];
    var coordinate = new google.maps.LatLng(lat, lng);
    var marker = zipcar.createMarker(coordinate, aMap, row );
    // marker.zipcarRow = row;
    zipcar.markers.push(marker);
  });
}

zipcar.updateMarkers = function() {
  if ($('#'+"zipcarLayer").is(':checked')) {
    zipcar.showAllMarkers(map);
  } else {
    zipcar.hideAllMarkers();
  }
}

zipcar.hideAllMarkers = function() {
  zipcar.markers.forEach(function(marker) { marker.setMap(null)} );
}

zipcar.showAllMarkers = function(aMap) {
  zipcar.markers.forEach(function(marker) { marker.setMap(aMap)} );
}

zipcar.createMarker = function(coordinate, aMap, row) {
  var marker = new google.maps.Marker({
    map: map,
    position: coordinate,
    zipcarRow: row,
    icon: new google.maps.MarkerImage('http://sandbox.idre.ucla.edu/up206b/groups/excela/wp-content/uploads/2014/06/ZipcarMarker.png')
  });

  google.maps.event.addListener( marker, 'click', function(event) {
    zipcar.infoWindow.setPosition(coordinate);
    zipcar.infoWindow.setContent('<b>Location Name: </b>' + marker.zipcarRow['Name']);
    zipcar.infoWindow.setPixelOffset = google.maps.Size(0,15);
    zipcar.infoWindow.open(aMap);
  })

  return marker;
}

function initialize() 
  {
    //Customization of the Google Map
    var mapOptions = 
      {
        center: new google.maps.LatLng(34.027624, -118.406525),
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        panControl: false,
        zoomControl: true,
        scaleControl: true,
        streetViewControl: false,
        mapTypeControlOptions: 
          {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
            position: google.maps.ControlPosition.RIGHT_BOTTOM
          },
        zoomControlOptions:
          {
            style: google.maps.ZoomControlStyle.SMALL,
            position: google.maps.ControlPosition.RIGHT_BOTTOM
          },
        mapTypeControl: true,
        styles:
          [
            {"featureType": "landscape","elementType": "labels","stylers": [{"visibility": "off"}]},
            {"featureType": "transit","elementType": "labels","stylers": [{"visibility": "off"}]},
            {"featureType": "poi","elementType": "labels","stylers": [{"visibility": "off"}]},
            {"featureType": "water","elementType": "labels","stylers": [{"visibility": "off"}]},
            {"featureType": "road","elementType": "labels.icon","stylers": [{"visibility": "off"}]},{"stylers": [{"hue": "#00aaff"},{"saturation": -100},{"gamma": 2.15},{"lightness": 12}]},
            {"featureType": "road","elementType": "labels.text.fill","stylers": [{"visibility": "on"},{"lightness": 24}]},
            {"featureType": "road","elementType": "geometry","stylers": [{"lightness": 57}]}]
    };

    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    var resetControlDiv = document.createElement('div');
    var resetControl = new ResetControl(resetControlDiv, map);

    resetControlDiv.index = 1;
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(resetControlDiv);

    var input = /** @type {HTMLInputElement} */(
        document.getElementById('pac-input'));

    map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);

    var infowindow = new google.maps.InfoWindow();

    //hover over polygons
    excela.hoverPolygons();

    //Vehicle Per Household Layer
    var vehperhhUrl='http://whippet.ats.ucla.edu/arcgis/rest/services/2014/Excela_finalservice/MapServer';

    vehperhh= new gmaps.ags.MapOverlay(vehperhhUrl, {opacity:0.7});
    google.maps.event.addListenerOnce(vehperhh.getMapService(), 'load', function() {
      vehperhh.setMap(map);
    });

    bikenetwork.setMap(null);
    railnetwork.setMap(null);

    //Metro Rail Layer
    //metrorail.initialize();

    //Zipcar layer
    zipcar.initialize();

    //Querying for Bus Stops
    google.maps.event.addListener(autocomplete, 'place_changed', function()
      {
        if (cityCircle!=null) {cityCircle.setMap(null);}
        if (centermarker!=null) {centermarker.setMap(null);}
        centermarker = new google.maps.Marker(
        {
          map: map,
          zIndex: 1500
        });

        infowindow.close();
        centermarker.setVisible(false);
        var place = autocomplete.getPlace();
        excela.getBusRoutes(place.geometry.location);
        if (!place.geometry) 
          {
            return;
          }
        map.setZoom(15);
        map.setCenter(place.geometry.location);

        centermarker.setPosition(place.geometry.location);
        centermarker.setVisible(true);

        var address = '';
        if (place.address_components) 
          {
            address =
              [
                (place.address_components[0] && place.address_components[0].short_name || ''),
                (place.address_components[1] && place.address_components[1].short_name || ''),
                (place.address_components[2] && place.address_components[2].short_name || '')
              ].join(' ');
          }

        var bufferOptions = 
          {
            strokeColor: "#66CC66",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#66CC66",
            fillOpacity: 0.1,
            map: map,
            center: place.geometry.location,
            radius: 800
          };
        cityCircle = new google.maps.Circle(bufferOptions);
      });

    //Sets a listener on a radio button to change the filter type on Places
    //Autocomplete
    
    //add an event listener to identify user location
    google.maps.event.addListener(map, 'click', function(event) {
        var lat = event.latLng.lat();
        var lng = event.latLng.lng();
        var latlng = new google.maps.LatLng(lat,lng);
        if (cityCircle!=null) {cityCircle.setMap(null);}
        excela.getBusRoutes(latlng);
        if (centermarker!=null) {centermarker.setMap(null);}
        centermarker = new google.maps.Marker(
        {
          position: latlng,
          map: map,
          zIndex: 1500
        });
        var bufferOptions = 
        {
          strokeColor: "#66CC66",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: "#66CC66",
          fillOpacity: 0.1,
          map: map,
          center: latlng,
          radius: 800
        };
        cityCircle = new google.maps.Circle(bufferOptions);
        excela.clickForChart(lat,lng);
    });
    
    //add a slider
    excela.addSlider('Med_Inc');

//feedback button
   $(function() {  
   //create and customize feedback dialog      
         $( "#fbdialog" ).dialog({
            autoOpen: false,
            height:450,
            width:500,
          }).prev(".ui-dialog-titlebar").css("background","#f7f7f7");

    // once click the "feedback button", open the dialog
          $("#fbbutton")
          .button()
          .click(function() {
            $( "#fbdialog" ).dialog( "open" );
          });
    // once click the sumbit button in the dialog, sumbit the feedback data
          $( "#entryform" ).submit(function( event ) {
            //prevent the default form behavior (which would refresh the page)
            event.preventDefault();

            var data = {
                email:            $("input[name=email]", this).val(),
                comment:          $("textarea[name=comment]", this).val()
                };
            console.log(data)
            
            $.post("adddata.php", data, excela.feedbackResponse, "json");
            $("#fbdialog").dialog( "close" );

           });
        });      
  }
  //end of initialize

  excela.feedbackResponse = function (data) {
  if (typeof data.error != "undefined")
      {
       console.log(data.error);
     }
   else 
     {    
        alert(data.message);
     }
 }

  //Customization of the Google Map
  function ResetControl(controlDiv, map) 
  {
    // Set CSS styles for the DIV containing the control
    // Setting padding to 5 px will offset the control
    // from the edge of the map
    controlDiv.style.padding = '5px';

    // Set CSS for the control border
    var controlUI = document.createElement('div');
    controlUI.style.backgroundColor = 'white';
    controlUI.style.borderStyle = 'solid';
    controlUI.style.borderWidth = '2px';
    controlUI.style.cursor = 'pointer';
    controlUI.style.textAlign = 'center';
    controlUI.title = 'Click to reset the map center';
    controlDiv.appendChild(controlUI);

    // Set CSS for the control interior
    var controlText = document.createElement('div');
    controlText.style.fontFamily = 'Arial,sans-serif';
    controlText.style.fontSize = '12px';
    controlText.style.paddingLeft = '4px';
    controlText.style.paddingRight = '4px';
    controlText.innerHTML = '<b>Reset</b>';
    controlUI.appendChild(controlText);

    // Setup the click event listeners: simply set the map to LA
    google.maps.event.addDomListener(controlUI, 'click', function()
      {
        map.setCenter(la)
      });
  }

  //Create a polygon from georss feed coming from AGS
  function createGeoJsonPolygon(geojson){
    //function from http://geojason.info/
    var paths = [];
    $.each(geojson,function(i,n){
      $.each(n,function(j,o){
        var path=[];
        $.each(o,function(k,p){
          var ll = new google.maps.LatLng(p[1],p[0]);
          path.push(ll);
        });
        paths.push(path);
      });
    });

    //what the polygon will look like on hover over or draw
    var polygon = new google.maps.Polygon({
      paths: paths,
      strokeColor: "#ffffff",
      strokeOpacity: 0, // invisible by default
      strokeWeight: 2,
      fillColor: "#ffff00",
      fillOpacity: 0 // invisible by default
    });
    return polygon;
  }

  excela.clickForChart=function(lat,lng){
    var url = 'http://whippet.ats.ucla.edu/arcgis/rest/services/2014/Excela_finalservice/MapServer/0/query?geometry='+lng+','+lat+'&geometryType=esriGeometryPoint&inSR=4326&where=1%3D1&outSR=4326&outFields=*&returnGeometry=false&f=json&callback=?';

    $.getJSON(url,function(data){
      if(data.features[0]==undefined){
        console.log("null");
        $("#veh_panel").hide();
        $("#income_panel").hide();
        $("#poverty_panel").hide();
      }
      else{
        $("#veh_panel").show();
        $("#income_panel").show();
        $("#poverty_panel").show();
        excela.drawChart(data.features[0]);   
      }
    });
  }
  excela.hoverPolygons = function(){
    var url = 'http://whippet.ats.ucla.edu/arcgis/rest/services/2014/Excela_finalservice/MapServer/0/query?inSR=4326&where=1%3D1&outSR=4326&outFields=*&returnGeometry=true&f=json&callback=?';

    $.getJSON(url,function(data){
      $.each(data.features,function(i,val){

        //create a google polygon by converting geoJSON
        polygons[i]=createGeoJsonPolygon(val.geometry);
        polygons[i].setMap(map);

        //on mouseover, highlight the polygon
        google.maps.event.addListener(polygons[i], 'mouseover', function(event){
          //highlight the polygon
          polygons[i].setOptions({strokeOpacity:.8,fillOpacity:.8})
        });

        //on mouseout, get rid of the highlight
        google.maps.event.addListener(polygons[i], 'mouseout', function(event){
          //remove highlight
          polygons[i].setOptions({strokeOpacity:0,fillOpacity:0})
        });

        //on click, chart the polygon
        google.maps.event.addListener(polygons[i], 'click', function(event){
          $("#veh_panel").show();
          $("#income_panel").show();
          $("#poverty_panel").show();
          excela.drawChart(val);

        });

      })
    });
  }

  excela.drawChart = function (val){

  var veh_chart = {
            
            chart: { 
              renderTo:veh_panel, 
              type:'pie',
              plotBackgroundColor: null,
              plotBorderWidth: null,
              plotShadow: false,
              margin:[40,0,25,0],
              width:250,
              height:200,
              style: {
                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
              },
            },
            title: { text: 'Vehicle Ownership By Household',
                     style: { fontSize:'11', fontWeight:'bold'},
                },            
            tooltip: { pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'},
            plotOptions: {
                pie: {
                    size:'90%',
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        connectorPadding: 0,
                        distance: 6,
                        format: '{y} households',
                        style:{ fontSize:'10'},
                    },                    
                    size: 80,                    
                    showInLegend: true
                }
            },
          legend: {
                layout: 'horizontal',
                backgroundColor: '#FFFFFF',
                floating: true,
                align: 'left',
                verticalAlign: 'bottom',
                itemStyle: {
                    color: '#000000',
                    fontSize:'9',
                  }, 
                x:-10,
                y:10,  
              },            
            series: [{
                type: 'pie',
                name: 'Pop share',
                data: [
                    ['0 vehicle', val.attributes.No_veh],
                    ['1 vehicle',val.attributes.One_veh],
                    ['2 vehicles',val.attributes.Two_veh],                    
                    ]
            }]     
        }
  
  var income_chart = {
            chart: { renderTo:income_panel, 
               type: 'bar',
               width: 220,
               height: 200,
               marginRight: 5,
               spacingBottom: 25,
               marginTop:40,
               style: {
                  color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
               },
             },

            title: { text: 'Median Household Income',
                     style: { fontSize:'11', fontWeight:'bold'}
                },

            xAxis: {labels:{ enabled: false}},

            yAxis: { min: 0,
                  title: { style:{fontSize:'10'} },
                  labels: { overflow: 'justify', style:{fontSize:'10'} },
                },
              
          plotOptions: { bar: { dataLabels: { enabled: true,  inside: 'true',
                    color: '#D8D8D8', format: '${y}' } } },

          legend: {
                layout: 'horizontal',
                backgroundColor: '#FFFFFF',
                floating: true,
                align: 'left',
                verticalAlign: 'bottom',
                itemStyle: {
                    color: '#000000',
                    fontSize:'9',
                  }, 
                x:-10,
                y:10,  
              },

            series: [{
                  name: 'Census Tract',
                  data: [val.attributes.Med_Inc], 
                  },
                  {
                  name: 'City Average',
                  data: [val.attributes.City_Med_I], 
                  }]       
        }

  var poverty_chart = {
             chart: { renderTo:poverty_panel, 
                type: 'bar',
                width: 220,
                height: 200,
                marginRight: 5,
                spacingBottom: 25,
                marginTop:40,
                style: {
                  color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                },
              },

            title: { text: 'Percentage of the Population in Poverty',
                     style: { fontSize:'11', fontWeight:'bold'}

                },

            xAxis: {labels:{ enabled: false}},

            yAxis: { min: 0,
                  title: { style:{fontSize:'10'} },
                  labels: { overflow: 'justify', style:{fontSize:'10'} },
                },
              
            plotOptions: { bar: { dataLabels: { enabled: true,  inside: 'true',
                    color: '#D8D8D8', format: '{y}%' } } },

            legend: {
                layout: 'horizontal',
                backgroundColor: '#FFFFFF',
                floating: true,
                align: 'left',
                verticalAlign: 'bottom',
                itemStyle: {
                    color: '#000000',
                    fontSize:'9',
                  }, 
                x:-10,
                y:10,  
              },

            series: [{
                  name: 'Census Tract',
                  data: [val.attributes.PctPopPov],
                  },
                  {
                  name: 'City Average',
                  data: [val.attributes.CityPov],  
                  }]       
        }

      var vehchart = new Highcharts.Chart(veh_chart);
      var incomechart = new Highcharts.Chart(income_chart);
      var povertychart = new Highcharts.Chart(poverty_chart);
  }


//filter polygons by income
excela.filterPolygons = function(min,max,parameter)
{
  // get the map service layer
  agsfilter = vehperhh.getMapService();

  // define the layer id, and apply the filter
  agsfilter.getLayer(0).definition = parameter + " >= "+min+" AND " + parameter + " <= "+max;

  // redraw the layer
  vehperhh.setMap(map);
}

excela.addSlider = function(parameter)
{
    //add a slider
  $( "#slider-range" ).slider({
      range: true,
      min: 0,
      max: 240000,
      step: 10000,
      values: [ 0, 240000 ],
      slide: function( event, ui ) {
        $( "#amount" ).val( "$" + ui.values[ 0 ] + " - $" + ui.values[ 1 ] );
        excela.filterPolygons(ui.values[ 0 ],ui.values[ 1 ],parameter);
      }
    });

    $( "#amount" ).val( "$" + $( "#slider-range" ).slider( "values", 0 ) +
      " - $" + $( "#slider-range" ).slider( "values", 1 ) );
}

  //Bus stop information
  excela.getBusRoutes= function(latlng)
    {
      excela.removeLayer();
      var numRoutes=0;
      $('#info').empty();
      $('#routeinfo').empty();
      $.getJSON('http://api.metro.net/agencies/lametro/routes/',
        function(data)
          {
            //loop through each item
            $.each(data.items, function(i,item)
              {
                //excela.getBusStops(item.id,latlng);
                if (excela.getBusStops(item.id,latlng))
                  {
                    numRoutes=numRoutes+1;
                  };
              });
          });
  }

  excela.getBusStops = function(routenum,latlng)
    {
      var routeconnected=0;
      var minimumdistance=distancemeterslimit;
      var bestlatlng;
      var display_name;
      var bestroutenum;
      var a=$.ajax(
        {
          url: 'http://api.metro.net/agencies/lametro/routes/' + routenum + '/sequence/',
          async: true,
          type: "get",
          dataType: "json",
          success: function(data)
            {
              // get the return value from the response and set it to retVal
              $.each(data.items, function(i,item)
              {
                var latLng2 = new google.maps.LatLng(item.latitude,item.longitude);
                var distance= google.maps.geometry.spherical.computeDistanceBetween(latlng, latLng2);
                if(distance<=minimumdistance)
                  {
                    routeconnected=1;
                    bestlatlng=latLng2;
                    bestroutenum=routenum;
                    display_name=item.display_name;
                    minimumdistance=distance;     
                    //excela.mapBusStop(bestlatlng,display_name, routenum);
                  }
              });
            }
        });
      
      a.done(function()
        {
          if(routeconnected=1)
            {
              excela.mapBusStop(bestlatlng,display_name, routenum);
              excela.getBusStopsLite(bestroutenum);
            }
          return routeconnected;
        });
    }

  excela.mapBusStop = function(latlng,name,routenum)
    {
      //create the lat/lon for this stop
      var infowindow = new google.maps.InfoWindow();

      var thisbusstop = new google.maps.Marker(
        {
          position: latlng,
          map: map,
          title: 'Route '+routenum+':'+name,
          icon: 'images/busstop.png',
          zIndex: 1500
        });

      google.maps.event.addListener(thisbusstop, 'click', function()
        {
          if (busstop2) 
            {
              for (i in busstop2)
                {
                    busstop2[i].setMap(null);
                }
              busstop2 = [];
            }
          excela.getBusStopsLite(routenum);
        });

      google.maps.event.addListener(thisbusstop, 'mouseover', function()
        {
          infowindow.setContent('Route '+routenum+':'+name);
          infowindow.open(map,this);
        });

      google.maps.event.addListener(thisbusstop, 'mouseout', function()
        {
          infowindow.close();
        });
      
      busstop.push(thisbusstop);

  }

excela.getBusStopsLite = function(routenum)
  {    
    if(lastClickedRoute!=routenum){
      lastClickedRoute=routenum;
      $.getJSON('http://api.metro.net/agencies/lametro/routes/' + routenum + '/sequence/', function(data)
        {
            $.each(data.items, function(i,item)
              {
                var lat=item.latitude;
                var lng=item.longitude;
                var name=item.display_name;
                excela.mapBusStopLite(lat,lng,name,routenum);
              });

        });
    }
    else{
      lastClickedRoute=0;
    }
  }

excela.mapBusStopLite = function(lat,lng,name, routenum)
  { 
    var latlng2 = new google.maps.LatLng(lat,lng); 
      var thisbusstop = new google.maps.Marker(
        {
          position: latlng2,
          map: map,
          title: 'Route '+routenum+':'+name,
          icon: 'images/busstop2.png',
          zIndex: 1500
        });
      busstop2.push(thisbusstop);
  }

excela.removeLayer = function()
  {
      if (busstop) 
        {
            for (i in busstop) 
              {
                busstop[i].setMap(null);
              }
            busstop = [];
        }
      if (busstop2) 
        {
            for (i in busstop2) 
              {
                busstop2[i].setMap(null);
              }
            busstop2 = [];
        }
  }

//Toggle layers
excela.toggleLayer = function(layer,id)
  {
      if ($('#'+id).is(':checked'))
        {
            layer.setMap(map);
        }
      else
        {
            layer.setMap(null);
        }
  }

//Toggle bike layer
excela.toggleBike = function()
  {
      if ($('#'+"bikeLayer").is(':checked'))
        {
            bikenetwork.setMap(map);
        }
      else
        {
            bikenetwork.setMap(null);
        }
  }

//Toggle metro rail layer
excela.togglePolylines = function()
  {
      if ($('#'+"metroLayer").is(':checked'))
        {
            railnetwork.setMap(map);
        }
      else
        {
            railnetwork.setMap(null);
        }
  }

excela.hoverOn=function(){
  excela.hoverPolygons();
}

excela.bufferOn=function(){
  for(var i in polygons){
    google.maps.event.clearListeners(polygons[i], 'click');
    google.maps.event.clearListeners(polygons[i], 'mouseover');
    google.maps.event.clearListeners(polygons[i], 'mouseout');
    polygons[i].setMap(null);
  }
  polygons=[];
}


google.maps.event.addDomListener(window, 'load', initialize);

$(function() {
    $( "#logo" ).draggable();
  });

</script>
</head>

<body>


<div class="jumbotron jumbo-image" style="height: 850px; margin-bottom: 0px;">
  <h1 style="">
    Shared-Use Mobility <br/>
    in Los Angeles

  </h1>
</div>

<div class="navbar navbar-static-top" role="navigation" data-200="top:-40px;" data-300="top:0px;" style="margin-bottom: 0px;">

  <div class="container">
    <a class="navbar-brand">Explore Shared-Use Mobility in Los Angeles</a>
    <span class="pull-right">
      <button type="button" class="btn btn-default navbar-btn" data-toggle="modal" data-target="#myModal">How to Use</button>
      <a class="btn btn-default navbar-btn" href="#shareduse-content" role="button">What is Shared-Use Mobility?</a>
    </span>
  </div>
</div>



<div style="width: 100%; height: 850px;">



    <!-- high chart-->
  <div id="veh_panel"></div>
  <div id="income_panel"></div>
  <div id="poverty_panel"></div>
 
    <!-- logo -->
  <div id="logo">
    <div id="logo_panel" align="center"> </div>

      <!-- Demographics -->
    <div id="overlay-panel">
      <input id="pac-input" class="controls" type="text" placeholder="Enter a location for bus service analysis">
      <div class="panel-group" id="accordion">
        <div class="panel panel-default">

          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                Analysis Tools <span class="caret"></span>
              </a>
            </h4>
          </div>

          <div id="collapseOne" class="panel-collapse collapse">
            <div class="panel-body">

              <div class="well well-sm" >    
                <label>Select by:</label>
                <div class="switch-toggle well">
                  <input id="vehperhh_checkbox" name="select" onclick="" type="radio" checked/> 
                  <label for="vehperhh_checkbox" onclick="excela.hoverOn()">Census tract</label>
                  <input id="buffer_click" name="select" onclick="" type="radio"/> 
                  <label for="buffer_click" onclick="excela.bufferOn()">Buffer</label>
                  <a class="btn btn-success"></a>
                </div>
              </div>
              
              <!-- slider -->
              <div id="slider">
                <div class="well well-sm" >                
                    <label for="amount" >Median Income Range</label>
                    <input type="text" id="amount" style="border:0; color:#000000; font-weight:bold;">
                    <div id="slider-range" align="center" style="width:170px;"></div>                
                </div>
              </div>

              <!-- Avg VehperHH -->
              <div class="well well-sm";>            
                    <label>Legend</label>
                    <p> Average Vehicles Per Household </p>
                    <img width="180" src="http://sandbox.idre.ucla.edu/up206b/2014/excela/images/vehownbar.jpg">               
              </div>

            </div>
          </div>

          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
                Shared-Use Mobility Options <span class="caret"></span>
              </a>
            </h4>
          </div>

          <div id="collapseTwo" class="panel-collapse collapse" align="left">
            <div class="panel-body">

              <label><input id="bikeLayer" onclick="excela.toggleBike()" type="checkbox" unchecked/> Bicycle Network </label><br>
              <label><input id="metroLayer" onclick="excela.togglePolylines()" type="checkbox" unchecked/> Metro Rail Network </label><br>
              <label><input id="zipcarLayer" onclick="zipcar.updateMarkers()" type="checkbox" unchecked/> Zipcar Sites </label><br>

            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  

  <div id="map-canvas" class="leaflet-container leaflet-fade-anim" style="width:100%; height:850px" tabindex="0">
  </div>

</div>


<div id="shareduse-content">
  <div class="container">
    <br><br><br><br>
    <h3> What is Shared-Use Mobility? </h3><br>

    <blockquote><p><span style="color: #fff; font-size: 18px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 30.600000381469727px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; display: inline !important; float: none;">Shared-use mobility is defined as mobility services that are shared among users including traditional public transportation services, such as buses and trains; taxis and limos; ridesharing (carpooling, vanpooling, and real time ridesharing services); carsharing (round-trip, one-way, and personal vehicle sharing); Transportation Network Companies; bikesharing; scooter sharing; shuttle services; neighborhood jitneys; and commercial delivery vehicles providing flexible goods movement.</span></p><br>
    
    <p><span style="color: #fff; font-size: 18px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 30.600000381469727px; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; display: inline !important; float: none;">&#8211; <a href="http://sharedusemobilitycenter.org/about-us/" style="color:yellow">Shared Use Mobility Center</a></span></p></blockquote><br>

    <p style="text-align: left; width: 80%; margin: 0 auto;">What does shared-use mobility means for people with limited access to transportation options? These services have the potential to make existing trips more efficient, by offering excess capacity or ownership to those who need it. Shared-use mobility challenges single-occupancy vehicular travel simply by sharing.</p><br>

    <p style="text-align: left; width: 80%; margin: 0 auto;">Traditional transit services like buses and trains are made possible because people are willing to share a common vehicle that traverses a common route. Similarly, ridesharing services such as carpooling and vanpooling work because people are willing to share a common vehicle that reaches a common destination.</p><br>

    <p style="text-align: left; width: 80%; margin: 0 auto;">Have you ever borrowed a book from the library? Shared-use mobility works like this too. People nowadays can find mobility options through the sharing economy. Services like carsharing, bikesharing, and scooter sharing provide access to mobility without having to partake in full ownership. Have you ever borrowed a book from a friend? Peer-to-peer services allow people to access various means of mobility from ordinary people. These days, people can publicly list their car, bike, or whatever for others to borrow, usually at a cost that is much lower than actually having to fully own it — same as reading a book without having to own it.</p><br>

    <p style="text-align: left; width: 80%; margin: 0 auto;">Shared-use mobility provides sensible and affordable means of getting around. It increases options for people with limited access to transportation.</p><br>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    <hr>

    <p style="text-align: center; font-size: 1.3em;">
      © 2014 Excela <a id="logo_link" href="http://sandbox.idre.ucla.edu/up206b/groups/excela/">
      <img src="http://sandbox.idre.ucla.edu/up206b/groups/excela/wp-content/uploads/2014/04/Favicon.png" width='20' style="vertical-align: top; padding-top: 1px;">
    </p>
  </div>
</div>


  <!--feedback-->
  <button id="fbbutton" type="button" class="btn btn-success">Feedback</button>
  
  <div id="fbdialog" title="Feedback for Excela" >
   <div id="entryform" id="entryform">
    <p>In the box below, please let us know what you like or dislike about the map.</p>
    <p>If you include your e-mail address, we can respond to you when we fix the problem you identify.</p>
      <form role="form" >
        <div class="form-group">
            <label>E-mail Address</label>
            <input type="email" class="form-control" name="email" placeholder="Enter your email" required="yes">
        </div>
        <div class="form-group">
            <label>Comment</label>
            <textarea name="comment" class="form-control" rows="4" placeholder="Enter your commment"required="yes"></textarea>
        </div>
        <div class="form-group">
            <button class="btn btn-success">Submit</button>
        </div>
      </form>
    </div>
  </div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">How to Use This Map</h4>
      </div>
      <div class="modal-body">

        <p>
        Thanks for visiting this site! Use this map to explore opportunities for <a href="http://sandbox.idre.ucla.edu/up206b/groups/excela/?page_id=33" target="_blank">shared-use mobility</a> in Los Angeles County using the following map features:
        </p><br>
        <ul>
          <li><strong>Census tract level analysis</strong>: click on a tract to view statistics on vehicle ownership by household, median household income, and poverty.</li><br>
          <li><strong>Point level analysis</strong>: click on a point to view bus stops within a 1/2 mile buffer. Or, enter a location in the address search bar.</li> <br>
          <li><strong>Median income slider</strong>: filter tracts by median household income. Areas with low incomes and low vehicle ownership are especially suitable for shared-use mobility interventions.</li><br>
          <li><strong>Existing mobility resources</strong>: explore the shared-use mobility options in Los Angeles: toggle map layers to display the bicycle network, Metro rail network, and Zipcar sites throughout Los Angeles.</li><br>         
        </ul>

      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>
  </div>
</div>


</body>
</html>